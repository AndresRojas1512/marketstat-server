worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format quic '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" "$http3"';
    access_log /var/log/nginx/access.log quic;

    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_min_length 1000;

    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=static_cache:10m max_size=1g inactive=60m use_temp_path=off;

    upstream backend_read_cluster {
        server ms_demo_api:8080      weight=2 max_fails=3 fail_timeout=30s;
        server ms_demo_api_ro_1:8080 weight=1 max_fails=3 fail_timeout=30s;
        server ms_demo_api_ro_2:8080 weight=1 max_fails=3 fail_timeout=30s;
    }

    upstream backend_write_cluster {
        server ms_demo_api:8080;
    }

    map $request_method $api_upstream {
        GET     backend_read_cluster;
        HEAD    backend_read_cluster;
        default backend_write_cluster; 
    }

    server {
        listen 443 ssl;

        http2 on;

        listen 443 quic reuseport;

        server_name localhost;
        absolute_redirect off;

        ssl_certificate     /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        ssl_protocols       TLSv1.2 TLSv1.3;

        add_header Alt-Svc 'h3=":8443"; ma=86400'; 
        add_header X-protocol $server_protocol always;

        server_tokens off;
        add_header Server "MarketStat App" always;

        root /usr/share/nginx/html;
        index index.html;

        location = / {
            try_files /index.html =404;
            add_header Link "</assets/status.css>; rel=preload; as=style";
            add_header Link "</diagrams/tech-diagrams/svg/usecase.svg>; rel=preload; as=image";
            
            proxy_cache static_cache;
            proxy_cache_valid 200 60m;
        }

        location /reserved/ {
            alias /usr/share/nginx/html/;
            try_files /index.html =404;
        }

        location /legacy {
            try_files /legacy.html =404;
        }

        location /documentation {
            try_files /documentation.html =404;
        }

        location /documentation-raw {
            alias /usr/share/nginx/html/README.md;
            default_type text/plain;
            charset utf-8;
        }

        location /assets/ {
            root /usr/share/nginx/html;
            expires 1d;
        }

        location /diagrams/ {
            root /usr/share/nginx/html;
        }

        location /status {
            try_files /status.html =404;
        }

        location /status-raw {
            stub_status;
            access_log off;
            allow all;
        }

        location = /api/v1 {
            return 301 /swagger/index.html;
        }

        location /api/v1/ {
            proxy_pass http://$api_upstream;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection keep-alive;
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/v2 {
            proxy_pass http://ms_demo_api:8080;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        location /swagger/ {
            proxy_pass http://ms_demo_api:8080/; 
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection keep-alive;
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
        location /swagger/v1/ {
            proxy_pass http://ms_demo_api:8080/swagger/v1/;
        }

        location /mirror/api/v1/ {
            proxy_pass http://ms_demo_api_mirror:8080/api/v1/;
            
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /mirror;
        }

        location /mirror/ {
            alias /usr/share/nginx/html/;
            try_files /index.html =404;
        }

        location /admin/ {
            proxy_pass http://ms_pgadmin:80; 
            proxy_set_header X-Script-Name /admin;
            proxy_set_header Host $host;
            proxy_redirect off;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /monitoring/ {
            proxy_pass http://ms_grafana:3000;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    server {
        listen 80;
        server_name localhost;
        
        location / {
            return 301 https://$host:8443$request_uri;
        }
    }
}
